## Система мониторинга оборудования и палнирования ТО 

Компактная версия на гитхабе: https://github.com/a-givertzman/rals/issues/2

## 1. Общие сведения

Программное обеспечение рассчитано на масштаб предприятия и может объединять оборудование одного или нескольких цехов.

Все площадки и оборудование выстраиваются в древовидную структуру.

## 2. Основные модули

*   Система мониторинга текущего состояния оборудования
    *   Отслеживание параметров режима работы в реальном времени
    *   Сбор исторических данных
    *   Анализ параметров режима работы оборудования
    *   Анализ вибрации
    *   Прогнозирование износа
    *   Рекомендации по внеплановому обслуживанию (в будущих версиях)
*   Планирование ТО
    *   Обзор всего оборудования
    *   Типизация элементов оборудования
    *   Типизация задач ТО
    *   Планирование ТО и трудозатрат (базовые функции, не заменяет ERP)
    *   Подготовка спецификаций для закупок (Простые списки)

## 3. Архитектура

*   **Данные**
    *   Обмен с бэклм - на именованных событиях
        *   Классификация событий
            *   Inf - спонтанное событи (от бэка к фронту)
            *   Rec - запрос от фронта к бэку, требующий обязательного скорейшего ответа
            *   ReqCon - ответ с данными на запрос Rec
            *   ReqErr - ответ с ошибкой на запрос Rec
            *   Cmd - команда фронта бэку, не требует обязательного ответа (например кнопки Прибавит / Убавить - не требуют ответа)
            *   CmdCon - Необязательное положительное подтверждение команды Cmd (может быть использовано для интерфейсов, подразумевающих подверждение успешного выполнения команды)
            *   CmdErr - Необязательное отрицательное подтверждение команды Cmd
    *   Общие правила использования событий
        *   _**Req**_ - для получения данных по _**Пользователям**_, _**Оборудованию**_, _**Работам**_, _**Документам**_ и _**Подтверждениям**_
        *   _**Inf**_ - для спонтанной передачи статусов _**Warn**_ и _**Alarm**_
    *   Реконнект - автоматический
        *   При обрывах и восстановлении связи обновляется статус в строке состояния
        *   А так же бэк пришлет события закэшенные для этой линии, если они вообще есть (при условии что подключение было восстановлено в пределах всего нескольких минут)
        *   Данные идущие по запросу останутся без изменений
*   **Пользователи**    
    *   Авторизация
    *   Группы
        *   Админ
            *   Полный доступ ко всем функциям систкемы (для разработчика и поставщика)
        *   Инженер
            *   Добавление, удаление Операторов
            *   Редактирует Оборудование
            *   <s>Дает дополнительные разрешения Операторам</s> - Может реализуем в следующих версиях редактор ролей
            *   Планирование Работ
            *   Подтверждение закрытия работ
        *   Оператор
            *   Обзор всех функций системы
            *   Квитирование событий
            *   Для окончательного завершения работ необходима виза Инженера
    *   События безопасности логируются в общий список событий с классом Info
        *   Авторизация пользователей
        *   Добавление / удаление пользователей
        *   Изменение прав пользователей
        *   Квитирование событий
*   **Оборудование** (дерево)
    *   Импортировать из таблички
        *   Дерево обычно небольшое, не будет превышать несколько тысяч записей, загружается целиком из базы в стейт фронтенда
        *   Узел дерева всегда имеет только одного родителя
        *   Из E-Plan в формате csv, делается разработчиком системы, не является функцией для конечного пользователя
        *   Примерный вид таблицы
            | id | parent_id | name | title | param1 | param2 | ... |
            |----|-----------|------|-------|--------|--------|-----|
            | 1 | null | АБВГ.XXXXXX.001 | Кран мостовой | height: 30m | width: 40m |  |
            | 2 | 1 | АБВГ.XXXXXX.002 | Лебедка главная | length: 100m |  |  |
            *   id - уникальный признак в E-Plan
            *   parent_id - id родительского элемента
            *   name - Пректное наименование
            *   title - Человеческое название
            *   param's - необходимый набор технических параметров оборудования, определяется расчетами износа и инженером по ТО
    *   Отобразить в виде дерева
    *   Характеристики оборудования
    *   Документы
    *   Графики ТО (список / календарь)
        *   Работы по ТО планируются пользователем,
            *   Внеплановые по заданным датам,
            *   Плановые ТО периодичностью
    *   Сигнализация (Класс, timestamp, Текст, Кометарий - можно вписать отвественного или что иное)
        *   Пишется в историю
        *   Хранится 3..5 лет (по желанию заказчика настраивается разработчиком / наладчиком)
        *   Отображается в двух списках
            *   Список событий - историческая хронология всех событий, может быть отфильтрована по датам, по Классу  тревоги, по тексту
            *   Список тревог - список активных в данный момент тревог
                *   Необходим для того что бы зафиксировать в области видимости важные критические события, особенно актуален когда общее количество событий достаточно большое и трудно оценить что там важно а что нет. События попавшие в список тревог ни куда не денуться до тех пор пока не будут ликвидированы их причины и они не будут подтверждены "Сквитированы" пользователем. Если причины тревоги не были устранены, то сквитировать такую тревогу невозможно. Таким образом список тревог в идеале должен быть пустым.
                *   Событие попадает в список тревог при наличии у него **Флага Тревога:**
                *   В список Активных - пока имеет значение логической "1" (причины тревоги не устранены)
                    *   Активная аврия не может быть сквитирована - требует устранения
                    *   Но можем дать возможность квитирования для _**Инженера**_, с автоматическим каким-то соментом и логированием в общую историю
                    *   Или еще какой-то обходной путь сквитировать то что не устранить, но в списке мешает
                *   В список Пролетевших - если значение измениться с "1" на "0" (причина тревоги устранена)
                    *   Будет удалено из пролетевших после квтирования
                    *   Квитирование выполняется с подтверждением и по желанию может быть прокомментировано, событие квитирования пишется в общий лог
                    *   Квитировать может Оператор, Инженер, Админ
        *   **Классы тревоги** событий сигнализации
            *   Info | ℹ️ | Default | Информационное сообщение
            *   Warning | ⚠️ | Желтый | Предупредительная сигнализация, требует внимания персонала, не препятствует дальнейшей работе
            *   Error | ❌ | Error | Возможно нужно выделить ошибки (в приложении, связи, на бэкенде) в отдельную категорию
            *   Alarm | **<span style="background-color:null">◯</span>** | Красный | Аварийная сигнализация, требует срочной реакции персонала, дальнейшая работа невозможна
        *   Степень износа
            *   Ранняя стадия износа (класс тревоги в списках событий/тревог: Warning)
            *   Развитый дефект (класс тревоги в списках событий/тревог: Warning)
            *   Критический износ (класс тревоги в списках событий/тревог: Alarm, флаг Тревога)
        *   Статус (Active / Archived)
            *   По умолчанию оборудование имеет статус _**Active**_
            *   _**Archived**_ - не отображаются в дереве оборудования
            *   Если оборудование удалено пользователем
                *   Переводим статус удаленного узла и всех дочерних из _**Active**_ в _**Archived**_
                *   Связанные _**События**_, _**Работы**_ и _**Отчеты**_ - остаются и отображаются
            *   В будущих версиях: расширить статусами _**Service**_ (Вывод в ремонт, ТО), **_Shutdown_** (Останов, вывод), и другими, а так же ввести понятие _**Downtime**_ - время простоя

*   **Виды работ**
    *   Могут иметь вложенность
    *   Примерный вид записи
        *   Наименование
        *   Требования по периодичности ТО (как часть характеристик оборудования, определяется производителем, ГОСТом, другими нормативными документами)
        *   Обеспечение
            *   Люди
            *   Материалы
            *   Прочие ресурсы
        *   Дедлайн
    *   Проверить и запретить циклы при сохранении
*   **Работа**
    *   Могут иметь вложенность (вложенность программно не ограничена, обычно не большая)
    *   Принадлежит одному узлу дерева оборудования
        *   Создание работы
            *   Может быть выбрана из Видов Работ (ссылаемся на вид работ, запись работы изначально пустая, все поля беруться из Вида. Поля, которые были изменены храняться в записи Работа, остально берется из Вида. 
            *   Или создается новая (новая может быть добавлена в Виды работ)
            *   Работу можно назначить на дату
            *   На множество дат (Экземпляры работ автоматически создаются для множества дат)
                *   Задав периодичность
                *   Задав диапазон дат
    *   Исполнитель (дочерние наследуют родительского)
    *   Дедлайн (Дедлайн дочерних <= Дедлайн родителя, проверяется при добавлении даботы)
        *   При изменении дедлайна
            *   Логировать изменение
            *   Пересчитать флаги _**Просрочено (**_флаг просрочено как обычно логируется_**)**_
    *   Статус
        *   Родительский статус вычисляются автоматиески
        *   Изменение статуса работ логируются в общую историю с классом Info
    *   Проверить и запретить циклы при сохранении
*   **Статус Работы**
    *   Принадлежит одной записи Работа
    *   Статус
        | Статус | Planned | InProgress | Paused | Confirmation | Completed | Cancelled |
        | :--- | :---: | :---: | :---: | :---: | :---: | :---: |
        | Planned | - | Yes | | | | Yes |
        | InProgress | | - | Yes | Yes | | Yes |
        | Paused | | Yes | - | Yes | | Yes |
        | Confirmation | | Yes | | - | Yes | Yes |
        | Completed | | | | | - | |
        | Cancelled | | | | | | - |
        *   Правила агрегации (дочерний -> родитель, <span style="color:#000000">приоритет сверху вниз</span>)
            *   <span style="color:#000000">Если есть Paused → Parent: Paused</span>
            *   <span style="color:#000000">Если есть Confirmation → Parent: Confirmation</span>
            *   <span style="color:#000000">Если есть InProgress → Parent: InProgress</span>
            *   <span style="color:#000000">Если все Completed → Parent: Completed</span>
            *   <span style="color:#000000">Если все Cancelled → Parent: Cancelled</span>
            *   <span style="color:#000000">Иначе Parent: Planned</span>
    *   Флаг _**Просрочено**_ (Родитель _**Просрочено**_ если хоть один вложенный элемент _**Просрочено**_)
        *   Установка флага логируются в общую историю с классом Warning
        *   Снятие флага логируются в общую историю с классом Info
    *   Подтверждение _**Инженером**_
        *   Исполнитель завершает -> Статус _**Confirmation**_
        *   Работа попадает в список "На подтверждение"
        *   _**Инженер**_ подтверждает:
            *   Если подтверждено -> Статус _**Completed**_
            *   Если отклонено -> Статус _**InProgress**_
    *   Отчет
    *   Комментарий
*   **Закупка** (Список деталей с артикулами и необходимыми для закупки характеристиками)
    *   Принадлежит **Работе**
    *   Статус
        *   Формирование (дата, составил)
        *   Отправлено (дата, отправил)
        *   Закрыто (дата, получил)
    *   Запись закупки
        *   Код заказа
        *   Наименование
        *   Количество
*   **Отчет по Работе**
    *   Принадлежит одной записи Статус Работы
    *   Описание
    *   Фотографии

## 4. Бэкенд

*   Работает как сервис
*   Опрашивает подключенные устройства
    *   Пром-контроллеры (Profinet / SLMP)
    *   Датчики виброаналитики (UDP)
*   Собирает и обрабатывает информацию
    *   Пишет историю по событиям
    *   Расчитывает износ оборудования
    *   Аналитике по датчикам вибрации
        *   Датчики вибрации подключены по UDP к бэкенду (Микросервис UDP-Client)
            *   Передают выборки с АЦП с частотой семплирования около 300 кГц
        *   Микросервис UDP-Client Собирает все выборки с подключенных датчиков
            *   Выполняет FFT для каждой выборки
            *   Массив результатов FFT поступает на фильтры (индивидуальный Threshold-фильтр, отсекающий несущественные колебания амплитуды)
            *   После фильтрации результаты FFT имеющие существенные изменения попадают в таблицу "day" БД (timestamp, freq, amp) для дальнейшей фильтрации
            *   Отдельно сохраняем
                *   Высокочастотные (Зарождение дефекта (микротрещины, поверхностная усталость))
                    *   Собственные частоты элементов подшипника 1 .. 5 кГц (независимо от частоты вращения вала)
                    *   Резонансные частоты датчика и корпуса 10 .. 30 кГц (High Frequency Detection (HFD), Shock Pulse Method (SPM) - метод ударных импульсов)
                    *   Спектр огибающей (Envelope Spectrum)
                        *   Полосовой фильтр к области 20–40 кГц
                        *   «Снять огибающую»,
                        *   Проверить наличие импульсов, следующие с частотами BPFO или BPFI
                *   FTF - Частота сепаратора (Fundamental Train Frequency)
                *   BPFI - Частота дефекта внутреннего кольца (Ball Pass Freq. Inner)
                *   BPFO - Частота дефекта наружного кольца (Ball Pass Freq. Outer)
                *   BSF - Частота дефекта тела качения (Ball Spin Frequency)

        *   Микросервис Аналитика Вибрации
            *   Микросервис фильтрации
                *   Запускается периодически
                    *   Раз в 24 часа
                        *   все записи из таблички day филтруются от периодических составляющих (с настройками перодов 1), результаты попадают в таблицу week
                    *   Раз в 7 дней
                        *   Все записи из таблички week филтруются от периодических составляющих (с настройками перодов 2), результаты попадают в таблицу month
                    *   Раз в 30 дней
                        *   Все записи из таблички month филтруются от периодических составляющих (с настройками перодов 2), результаты попадают в таблицу year
                    *   Раз в 360 дней
                        *   Все записи из таблички month филтруются от периодических составляющих (с настройками перодов 2), результаты попадают в таблицу va-trend
            *   Микросервис Аналитики
                *   Запускается по запросу фронтенда
        *   Степень износа
            *   Ранняя стадия: Появление высокочастотных составляющих (ультразвук) и гармоник. (Warning)
            *   Развитый дефект: Появление выраженных пиков на основных частотах и их гармониках (2x, 3x BPFO). (Alarm)
            *   Критический износ: Рост «шумового порога» (noise floor) и исчезновение четких пиков из-за хаотичного биения. (Alarm)
*   Отправляет текущие значения износа и сигнализации клиентам
*   Слушает события от фронтенда
    *   Выполняет команды
    *   Отвечает на запросы

## 5. Фронтенда

*   **Данные**
    *   Обмен с бэкендом на именованных событиях (Inf, Rec, ReqCon, ReqErr, Cmd, CmdCon, CmdErr)
    *   Реконнект - автоматический, обновление _**Статуса**_
*   **Пользователи**
    *   Авторизация
    *   Регистрация нового пользователя
    *   Управление пользователями
*   **Page | Главный экран**
    *   **Оборудование** (Дерево на панели слева)
        *   Узел дерева
            *   Статус (Обобщает Статус Виброаналитики, износа, ТО)
                *   Red icon - Alarm (красный)
                *   Warning icon<span> - </span>Warning (желтый)
                *   ⏰ - Просрочка ТО
            *   Наименование
        *   Узел дерева можно добавить в Работе -> Закупка
    *   **Мониторинг** **оборудования** (Центральная часть -> Вкладка **Мониторинг**)
        *   Сделать неактивной если нечего показать
        *   Параметры текущего режима работы, если есть 
        *   Информация по износу и виброаналитике, если есть
    *   **Характеристики оборудования** (Центральная часть -> Вкладка **Характеристики**)
        *   Список полей (ключ - значение), как вариант можно отобразить в таблице
            *   Ключ - уникальный для одного узла, отображдаемый текст и перевод формируются из ключа и храняться в БД в таблице переводов
            *   Типв значений - хранится в БД вместе со значением
        *   Таблицы
        *   Редактирование при наличии прав 
    *   **Документы** (Центральная часть -> Вкладка **Документы**)
        *   Список приложенных документов
        *   Просмотр выбранного (HTML - в окне приложения / PDF - желательно во встоенном PDF-viewer)
        *   Добавление документа
        *   Удаление документа
    *   **Графики ТО** (список) (Центральная часть -> Вкладка Сервис)
        *   Отображение работ в таблице (видны только корневые задачи, вложенные можно открыть по клику в отдельном окне **Навигатор-Редактор Работ**)
            *   Фильтр "По умолчанию" :
                *   Сначала _**Просроченные**_ работы с иконкой ⏰
                *   Потом _**InProgress, Paused, Confirmation**_
                *   Ниже работы _**Planned**_
                    *   5..1 дней_ до **Просрочке**_  - подсветить цветом Warning
            *   Фильтр по статусу, по флагам, по исполнителю
        *   Добавление работ (отобразить вложенным списком)
            *   Добавление Работ из списка Видов работ
            *   Кастомизация списка работ (**Редактор Работ**)
            *   На конкретную дату или с периодичностью 
            *   Можно назначить исполнителя
        *   Ведение работ
            *   Показать работу вложенным списком (treeview)
            *   Можно назначить исполнителя
            *   Можно изменить статус
                *   При Отмене запросить комментарий
                *   При Завершении запросить отчет
                    *   Описание - текст
                    *   Приложить файл (Изображение / документ)
            *   Можно сформировать Закупку (Список деталей с артикулами и необходимыми для закупки характеристиками)
                *   Можно добавить запись сформированную из узла дерева Оборудования, с явным ручным указанием вложенных елементов
                *   Можно добавить вручную
                *   Статус (Формирование / Отправлено / Закрыто)
                    *   <s>Опционально статус можно указать записям закупки (Черновик / Отправлено / Закрыто)</s> - Может быть в будущих версиях
*   **Page | 3D View**
    *   Обзор модели оборудования
    *   Индикачия режима, износа и виброаналитика цветными лампочками рядом с соответствующим узлом оборудования
    *   Индикация тревог (иконка, цвет, мерцание)
    *   Переход между 3D и деревом: правый клик -> Показать в 3D / Дереве 
*   **Widget | Строка состояния** (мини Dashboard)
    *   Обновляется в реальном времени
    *   Иконки фиксированной ширины (не зависимо от контента)
        *   Когда количество 0, поле есть , но пустое, имеет цвет фона, не привлекает внимания
    *   Количество активных тревог
        *   Warn - желтый
        *   Alarm - красный (и возможно мерцает первые N секунда - задать в конфиг файле)
    *   Количество просроченных Работ
    *   Количество работ на подтверждении
    *   Статус связи с бэком
*   **Page | Сигнализация**
    *   Вкладка События
        *   Отображает события в таблице
        *   Позволяет фильтровать по
            *   По умолчанию последние 24 часа
            *   По оборудованию
            *   По работе
            *   По пользователю
            *   По ...
    *   Вкладка Аварии
        *   Отображает два списка
            *   Активные аварии - события, имеющие Класс аварии и имеющие в данный момент логическое значение "1"
                *   Сортировать по Классу + дате
            *   Пролетевшие аварии события, имеющие Класс аварии и сменившие логическое значение с "1" на "0", но еще не сквитированные
                *   Можно сквитировать, тогда они уйдут из списка
*   **Page | Список На подтверждение** (Для Инженеров)
    *   Окно открывается кликом по иконке в стоке статуса, Иконка "горит" когда в списке есть записи
    *   Фильтрация
    *   Просмотр отчета перед подтверждением
    *   Факт подтверждения логируется в общую историю
*   **Widget | Редактор Работ**
    *   Форма для редактирования одной записи Работ
    *   Нужно определить какие поля доступны в режиме редактирования уже созданных работ
        *   Для Статуса Planned: Больше доступно
        *   Для остальных статусов: Меньше доступно
*   **Page | Навигатор** / Видов работ
    *   Показать вложенным списком (treeview)
        *   Поиск и(или) фильтр
    *   Добавление / Удаление / редактирование полей
    *   Дублирование
    *   Выбранную работу править в форме **Редактор Работ**
    *   Глубину вложенности ограничить настройкой из конфиг файла (предлагаю 3..5)

## 6. В будущих версиях

*   **Фронтенд**
    *   **Page | Список На подтверждение** (Для Инженеров)
        *   Массовое подтверждение - если будет запрос от заказчика
            *   Выбраем несколько на подтверждение
            *   Жмем подвердить
            *   Очеты работ открываются для просмотра поочередно
                *   Есть кнопки Подтвердить / Отклонить
                *   Оба варианта требуют комментария
*   **Архитектура**
    *   **Работа**
        *   Зависит от (что бы указать блокирующие задачи)
    *   **Закупку** (Список деталей с артикулами и необходимыми для закупки характеристиками)
        *   Запись закупки
            *   Статус (Формирование / Отправлено / Закрыто) 
    *   **Оборудование** (дерево)
        *   Перетаскивание узлов дерева (на фронтенде)
        *   Сложные связи
            *   Дополнительные ссылки (связи с родителями)
            *   На фронтенде узел будет виден (в виде ссылки с иконкой и tultip показывает кто Original) во всех узлах куда есть ссылки
            *   На логику ссылки не влияют - но это не факт что получится
            *   Удаление ссылки - удаленный узел больше не виден в родителе, но остался в фактическом родителе (удаление происходит с уведомлением пользователя об этом)
            *   Удаление из фактического родителя приведет к удалению элемента и всех егно ссылок (удаление происходит с уведомлением пользователя об этом)
                *   Ссылки можно хранить массивом в записи элемента - тогда процесс удаления проще
            *   Вопрос как расчитывать агрегатные значения при наличии ссылки
        *   Downtime - допустимое время простоя
        *   Статус
            *   По умолчанию оборудование имеет статус _**Active**_
            *   _**Archived**_ - не отображаются в дереве оборудования
                *   Если оборудование удалено пользователем
                    *   Переводим статус удаленного узла и всех дочерних из _**Active**_ в _**Archived**_
                    *   Связанные _**События**_, _**Работы**_ и _**Отчеты**_ - остаются и отображаются
            *   **Service** - Вывод в ремонт, ТО
            *   **Shutdown** - Останов
